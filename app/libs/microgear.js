const VERSION="1.1.7";const GEARAPIADDRESS="ga.netpie.io";const GEARAPIPORT="8080";const GEARAPISECUREPORT="8081";const GBWSPORT="8083";const GBWSSPORT="8084";const USETLS=true;const MGREV="WJS1b";const MINTOKDELAYTIME=100;const MAXTOKDELAYTIME=3e4;const DEBUGMODE=false;const MONLOOPINTERVAL=1e3;const RETRYCONNECTIONINTERVAL=5e3;const MESSAGEBUFFERSIZE=20;var toktime=MINTOKDELAYTIME;var GEARAUTH=GEARAPIADDRESS;var storejs=function(){var store={},win=typeof window!="undefined"?window:global,doc=win.document,localStorageName="localStorage",scriptTag="script",storage;store.disabled=false;store.version="1.3.20";store.set=function(key,value){};store.get=function(key,defaultVal){};store.has=function(key){return store.get(key)!==undefined};store.remove=function(key){};store.clear=function(){};store.transact=function(key,defaultVal,transactionFn){if(transactionFn==null){transactionFn=defaultVal;defaultVal=null}if(defaultVal==null){defaultVal={}}var val=store.get(key,defaultVal);transactionFn(val);store.set(key,val)};store.getAll=function(){};store.forEach=function(){};store.serialize=function(value){return JSON.stringify(value)};store.deserialize=function(value){if(typeof value!="string"){return undefined}try{return JSON.parse(value)}catch(e){return value||undefined}};function isLocalStorageNameSupported(){try{return localStorageName in win&&win[localStorageName]}catch(err){return false}}if(isLocalStorageNameSupported()){storage=win[localStorageName];store.set=function(key,val){if(val===undefined){return store.remove(key)}storage.setItem(key,store.serialize(val));return val};store.get=function(key,defaultVal){var val=store.deserialize(storage.getItem(key));return val===undefined?defaultVal:val};store.remove=function(key){storage.removeItem(key)};store.clear=function(){storage.clear()};store.getAll=function(){var ret={};store.forEach(function(key,val){ret[key]=val});return ret};store.forEach=function(callback){for(var i=0;i<storage.length;i++){var key=storage.key(i);callback(key,store.get(key))}}}else if(doc&&doc.documentElement.addBehavior){var storageOwner,storageContainer;try{storageContainer=new ActiveXObject("htmlfile");storageContainer.open();storageContainer.write("<"+scriptTag+">document.w=window</"+scriptTag+'><iframe src="/favicon.ico"></iframe>');storageContainer.close();storageOwner=storageContainer.w.frames[0].document;storage=storageOwner.createElement("div")}catch(e){storage=doc.createElement("div");storageOwner=doc.body}var withIEStorage=function(storeFunction){return function(){var args=Array.prototype.slice.call(arguments,0);args.unshift(storage);storageOwner.appendChild(storage);storage.addBehavior("#default#userData");storage.load(localStorageName);var result=storeFunction.apply(store,args);storageOwner.removeChild(storage);return result}};var forbiddenCharsRegex=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");var ieKeyFix=function(key){return key.replace(/^d/,"___$&").replace(forbiddenCharsRegex,"___")};store.set=withIEStorage(function(storage,key,val){key=ieKeyFix(key);if(val===undefined){return store.remove(key)}storage.setAttribute(key,store.serialize(val));storage.save(localStorageName);return val});store.get=withIEStorage(function(storage,key,defaultVal){key=ieKeyFix(key);var val=store.deserialize(storage.getAttribute(key));return val===undefined?defaultVal:val});store.remove=withIEStorage(function(storage,key){key=ieKeyFix(key);storage.removeAttribute(key);storage.save(localStorageName)});store.clear=withIEStorage(function(storage){var attributes=storage.XMLDocument.documentElement.attributes;storage.load(localStorageName);for(var i=attributes.length-1;i>=0;i--){storage.removeAttribute(attributes[i].name)}storage.save(localStorageName)});store.getAll=function(storage){var ret={};store.forEach(function(key,val){ret[key]=val});return ret};store.forEach=withIEStorage(function(storage,callback){var attributes=storage.XMLDocument.documentElement.attributes;for(var i=0,attr;attr=attributes[i];++i){callback(attr.name,store.deserialize(storage.getAttribute(attr.name)))}})}try{var testKey="__storejs__";store.set(testKey,testKey);if(store.get(testKey)!=testKey){store.disabled=true}store.remove(testKey)}catch(e){store.disabled=true}store.enabled=!store.disabled;return store}();console.log(storejs.enabled);var _localStorage={setItem:function(key,value){if(storejs.enabled){storejs.set(key,value)}},getItem:function(){if(storejs.enabled){return storejs.get(key)}},removeItem:function(){if(storejs.enabled){storejs.remove(key)}},getAllItems:function(){return storejs.getAll()}};if(typeof Paho==="undefined"){Paho={}}Paho.MQTT=function(global){var version="1.0.1";var buildLevel="2014-11-18T11:57:44Z";var MESSAGE_TYPE={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14};var validate=function(obj,keys){for(var key in obj){if(obj.hasOwnProperty(key)){if(keys.hasOwnProperty(key)){if(typeof obj[key]!==keys[key])throw new Error(format(ERROR.INVALID_TYPE,[typeof obj[key],key]))}else{var errorStr="Unknown property, "+key+". Valid properties are:";for(var key in keys)if(keys.hasOwnProperty(key))errorStr=errorStr+" "+key;throw new Error(errorStr)}}}};var scope=function(f,scope){return function(){return f.apply(scope,arguments)}};var ERROR={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."}};var CONNACK_RC={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"};var format=function(error,substitutions){var text=error.text;if(substitutions){var field,start;for(var i=0;i<substitutions.length;i++){field="{"+i+"}";start=text.indexOf(field);if(start>0){var part1=text.substring(0,start);var part2=text.substring(start+field.length);text=part1+substitutions[i]+part2}}}return text};var MqttProtoIdentifierv3=[0,6,77,81,73,115,100,112,3];var MqttProtoIdentifierv4=[0,4,77,81,84,84,4];var WireMessage=function(type,options){this.type=type;for(var name in options){if(options.hasOwnProperty(name)){this[name]=options[name]}}};WireMessage.prototype.encode=function(){var first=(this.type&15)<<4;var remLength=0;var topicStrLength=new Array;var destinationNameLength=0;if(this.messageIdentifier!=undefined)remLength+=2;switch(this.type){case MESSAGE_TYPE.CONNECT:switch(this.mqttVersion){case 3:remLength+=MqttProtoIdentifierv3.length+3;break;case 4:remLength+=MqttProtoIdentifierv4.length+3;break}remLength+=UTF8Length(this.clientId)+2;if(this.willMessage!=undefined){remLength+=UTF8Length(this.willMessage.destinationName)+2;var willMessagePayloadBytes=this.willMessage.payloadBytes;if(!(willMessagePayloadBytes instanceof Uint8Array))willMessagePayloadBytes=new Uint8Array(payloadBytes);remLength+=willMessagePayloadBytes.byteLength+2}if(this.userName!=undefined)remLength+=UTF8Length(this.userName)+2;if(this.password!=undefined)remLength+=UTF8Length(this.password)+2;break;case MESSAGE_TYPE.SUBSCRIBE:first|=2;for(var i=0;i<this.topics.length;i++){topicStrLength[i]=UTF8Length(this.topics[i]);remLength+=topicStrLength[i]+2}remLength+=this.requestedQos.length;break;case MESSAGE_TYPE.UNSUBSCRIBE:first|=2;for(var i=0;i<this.topics.length;i++){topicStrLength[i]=UTF8Length(this.topics[i]);remLength+=topicStrLength[i]+2}break;case MESSAGE_TYPE.PUBREL:first|=2;break;case MESSAGE_TYPE.PUBLISH:if(this.payloadMessage.duplicate)first|=8;first=first|=this.payloadMessage.qos<<1;if(this.payloadMessage.retained)first|=1;destinationNameLength=UTF8Length(this.payloadMessage.destinationName);remLength+=destinationNameLength+2;var payloadBytes=this.payloadMessage.payloadBytes;remLength+=payloadBytes.byteLength;if(payloadBytes instanceof ArrayBuffer)payloadBytes=new Uint8Array(payloadBytes);else if(!(payloadBytes instanceof Uint8Array))payloadBytes=new Uint8Array(payloadBytes.buffer);break;case MESSAGE_TYPE.DISCONNECT:break;default:}var mbi=encodeMBI(remLength);var pos=mbi.length+1;var buffer=new ArrayBuffer(remLength+pos);var byteStream=new Uint8Array(buffer);byteStream[0]=first;byteStream.set(mbi,1);if(this.type==MESSAGE_TYPE.PUBLISH)pos=writeString(this.payloadMessage.destinationName,destinationNameLength,byteStream,pos);else if(this.type==MESSAGE_TYPE.CONNECT){switch(this.mqttVersion){case 3:byteStream.set(MqttProtoIdentifierv3,pos);pos+=MqttProtoIdentifierv3.length;break;case 4:byteStream.set(MqttProtoIdentifierv4,pos);pos+=MqttProtoIdentifierv4.length;break}var connectFlags=0;if(this.cleanSession)connectFlags=2;if(this.willMessage!=undefined){connectFlags|=4;connectFlags|=this.willMessage.qos<<3;if(this.willMessage.retained){connectFlags|=32}}if(this.userName!=undefined)connectFlags|=128;if(this.password!=undefined)connectFlags|=64;byteStream[pos++]=connectFlags;pos=writeUint16(this.keepAliveInterval,byteStream,pos)}if(this.messageIdentifier!=undefined)pos=writeUint16(this.messageIdentifier,byteStream,pos);switch(this.type){case MESSAGE_TYPE.CONNECT:pos=writeString(this.clientId,UTF8Length(this.clientId),byteStream,pos);if(this.willMessage!=undefined){pos=writeString(this.willMessage.destinationName,UTF8Length(this.willMessage.destinationName),byteStream,pos);pos=writeUint16(willMessagePayloadBytes.byteLength,byteStream,pos);byteStream.set(willMessagePayloadBytes,pos);pos+=willMessagePayloadBytes.byteLength}if(this.userName!=undefined)pos=writeString(this.userName,UTF8Length(this.userName),byteStream,pos);if(this.password!=undefined)pos=writeString(this.password,UTF8Length(this.password),byteStream,pos);break;case MESSAGE_TYPE.PUBLISH:byteStream.set(payloadBytes,pos);break;case MESSAGE_TYPE.SUBSCRIBE:for(var i=0;i<this.topics.length;i++){pos=writeString(this.topics[i],topicStrLength[i],byteStream,pos);byteStream[pos++]=this.requestedQos[i]}break;case MESSAGE_TYPE.UNSUBSCRIBE:for(var i=0;i<this.topics.length;i++)pos=writeString(this.topics[i],topicStrLength[i],byteStream,pos);break;default:}return buffer};function decodeMessage(input,pos){var startingPos=pos;var first=input[pos];var type=first>>4;var messageInfo=first&=15;pos+=1;var digit;var remLength=0;var multiplier=1;do{if(pos==input.length){return[null,startingPos]}digit=input[pos++];remLength+=(digit&127)*multiplier;multiplier*=128}while((digit&128)!=0);var endPos=pos+remLength;if(endPos>input.length){return[null,startingPos]}var wireMessage=new WireMessage(type);switch(type){case MESSAGE_TYPE.CONNACK:var connectAcknowledgeFlags=input[pos++];if(connectAcknowledgeFlags&1)wireMessage.sessionPresent=true;wireMessage.returnCode=input[pos++];break;case MESSAGE_TYPE.PUBLISH:var qos=messageInfo>>1&3;var len=readUint16(input,pos);pos+=2;var topicName=parseUTF8(input,pos,len);pos+=len;if(qos>0){wireMessage.messageIdentifier=readUint16(input,pos);pos+=2}var message=new Paho.MQTT.Message(input.subarray(pos,endPos));if((messageInfo&1)==1)message.retained=true;if((messageInfo&8)==8)message.duplicate=true;message.qos=qos;message.destinationName=topicName;wireMessage.payloadMessage=message;break;case MESSAGE_TYPE.PUBACK:case MESSAGE_TYPE.PUBREC:case MESSAGE_TYPE.PUBREL:case MESSAGE_TYPE.PUBCOMP:case MESSAGE_TYPE.UNSUBACK:wireMessage.messageIdentifier=readUint16(input,pos);break;case MESSAGE_TYPE.SUBACK:wireMessage.messageIdentifier=readUint16(input,pos);pos+=2;wireMessage.returnCode=input.subarray(pos,endPos);break;default:}return[wireMessage,endPos]}function writeUint16(input,buffer,offset){buffer[offset++]=input>>8;buffer[offset++]=input%256;return offset}function writeString(input,utf8Length,buffer,offset){offset=writeUint16(utf8Length,buffer,offset);stringToUTF8(input,buffer,offset);return offset+utf8Length}function readUint16(buffer,offset){return 256*buffer[offset]+buffer[offset+1]}function encodeMBI(number){var output=new Array(1);var numBytes=0;do{var digit=number%128;number=number>>7;if(number>0){digit|=128}output[numBytes++]=digit}while(number>0&&numBytes<4);return output}function UTF8Length(input){var output=0;for(var i=0;i<input.length;i++){var charCode=input.charCodeAt(i);if(charCode>2047){if(55296<=charCode&&charCode<=56319){i++;output++}output+=3}else if(charCode>127)output+=2;else output++}return output}function stringToUTF8(input,output,start){var pos=start;for(var i=0;i<input.length;i++){var charCode=input.charCodeAt(i);if(55296<=charCode&&charCode<=56319){var lowCharCode=input.charCodeAt(++i);if(isNaN(lowCharCode)){throw new Error(format(ERROR.MALFORMED_UNICODE,[charCode,lowCharCode]))}charCode=(charCode-55296<<10)+(lowCharCode-56320)+65536}if(charCode<=127){output[pos++]=charCode}else if(charCode<=2047){output[pos++]=charCode>>6&31|192;output[pos++]=charCode&63|128}else if(charCode<=65535){output[pos++]=charCode>>12&15|224;output[pos++]=charCode>>6&63|128;output[pos++]=charCode&63|128}else{output[pos++]=charCode>>18&7|240;output[pos++]=charCode>>12&63|128;output[pos++]=charCode>>6&63|128;output[pos++]=charCode&63|128}}return output}function parseUTF8(input,offset,length){var output="";var utf16;var pos=offset;while(pos<offset+length){var byte1=input[pos++];if(byte1<128)utf16=byte1;else{var byte2=input[pos++]-128;if(byte2<0)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),""]));if(byte1<224)utf16=64*(byte1-192)+byte2;else{var byte3=input[pos++]-128;if(byte3<0)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16)]));if(byte1<240)utf16=4096*(byte1-224)+64*byte2+byte3;else{var byte4=input[pos++]-128;if(byte4<0)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16),byte4.toString(16)]));if(byte1<248)utf16=262144*(byte1-240)+4096*byte2+64*byte3+byte4;else throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16),byte4.toString(16)]))}}}if(utf16>65535){utf16-=65536;output+=String.fromCharCode(55296+(utf16>>10));utf16=56320+(utf16&1023)}output+=String.fromCharCode(utf16)}return output}var Pinger=function(client,window,keepAliveInterval){this._client=client;this._window=window;this._keepAliveInterval=keepAliveInterval*1e3;this.isReset=false;var pingReq=new WireMessage(MESSAGE_TYPE.PINGREQ).encode();var doTimeout=function(pinger){return function(){return doPing.apply(pinger)}};var doPing=function(){if(!this.isReset){this._client._trace("Pinger.doPing","Timed out");this._client._disconnected(ERROR.PING_TIMEOUT.code,format(ERROR.PING_TIMEOUT))}else{this.isReset=false;this._client._trace("Pinger.doPing","send PINGREQ");this._client.socket.send(pingReq);this.timeout=this._window.setTimeout(doTimeout(this),this._keepAliveInterval)}};this.reset=function(){this.isReset=true;this._window.clearTimeout(this.timeout);if(this._keepAliveInterval>0)this.timeout=setTimeout(doTimeout(this),this._keepAliveInterval)};this.cancel=function(){this._window.clearTimeout(this.timeout)}};var Timeout=function(client,window,timeoutSeconds,action,args){this._window=window;if(!timeoutSeconds)timeoutSeconds=30;var doTimeout=function(action,client,args){return function(){return action.apply(client,args)}};this.timeout=setTimeout(doTimeout(action,client,args),timeoutSeconds*1e3);this.cancel=function(){this._window.clearTimeout(this.timeout)}};var ClientImpl=function(uri,host,port,path,clientId){if(!("WebSocket"in global&&global["WebSocket"]!==null)){throw new Error(format(ERROR.UNSUPPORTED,["WebSocket"]))}if(!("ArrayBuffer"in global&&global["ArrayBuffer"]!==null)){throw new Error(format(ERROR.UNSUPPORTED,["ArrayBuffer"]))}this._trace("Paho.MQTT.Client",uri,host,port,path,clientId);this.host=host;this.port=port;this.path=path;this.uri=uri;this.clientId=clientId;this._localKey=host+":"+port+(path!="/mqtt"?":"+path:"")+":"+clientId+":";this._msg_queue=[];this._sentMessages={};this._receivedMessages={};this._notify_msg_sent={};this._message_identifier=1;this._sequence=0;for(var key in _localStorage.getItems)if(key.indexOf("Sent:"+this._localKey)==0||key.indexOf("Received:"+this._localKey)==0)this.restore(key)};ClientImpl.prototype.host;ClientImpl.prototype.port;ClientImpl.prototype.path;ClientImpl.prototype.uri;ClientImpl.prototype.clientId;ClientImpl.prototype.socket;ClientImpl.prototype.connected=false;ClientImpl.prototype.maxMessageIdentifier=65536;ClientImpl.prototype.connectOptions;ClientImpl.prototype.hostIndex;ClientImpl.prototype.onConnectionLost;ClientImpl.prototype.onMessageDelivered;ClientImpl.prototype.onMessageArrived;ClientImpl.prototype.onError;ClientImpl.prototype.traceFunction;ClientImpl.prototype._msg_queue=null;ClientImpl.prototype._connectTimeout;ClientImpl.prototype.sendPinger=null;ClientImpl.prototype.receivePinger=null;ClientImpl.prototype.receiveBuffer=null;ClientImpl.prototype._traceBuffer=null;ClientImpl.prototype._MAX_TRACE_ENTRIES=100;ClientImpl.prototype.connect=function(connectOptions){var connectOptionsMasked=this._traceMask(connectOptions,"password");this._trace("Client.connect",connectOptionsMasked,this.socket,this.connected);if(this.connected)throw new Error(format(ERROR.INVALID_STATE,["already connected"]));if(this.socket)throw new Error(format(ERROR.INVALID_STATE,["already connected"]));this.connectOptions=connectOptions;if(connectOptions.uris){this.hostIndex=0;this._doConnect(connectOptions.uris[0])}else{this._doConnect(this.uri)}};ClientImpl.prototype.subscribe=function(filter,subscribeOptions){this._trace("Client.subscribe",filter,subscribeOptions);if(!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));var wireMessage=new WireMessage(MESSAGE_TYPE.SUBSCRIBE);wireMessage.topics=[filter];if(subscribeOptions.qos!=undefined)wireMessage.requestedQos=[subscribeOptions.qos];else wireMessage.requestedQos=[0];if(subscribeOptions.onSuccess){wireMessage.onSuccess=function(grantedQos){subscribeOptions.onSuccess({invocationContext:subscribeOptions.invocationContext,grantedQos:grantedQos})}}if(subscribeOptions.onFailure){wireMessage.onFailure=function(errorCode){subscribeOptions.onFailure({invocationContext:subscribeOptions.invocationContext,errorCode:errorCode})}}if(subscribeOptions.timeout){wireMessage.timeOut=new Timeout(this,window,subscribeOptions.timeout,subscribeOptions.onFailure,[{invocationContext:subscribeOptions.invocationContext,errorCode:ERROR.SUBSCRIBE_TIMEOUT.code,errorMessage:format(ERROR.SUBSCRIBE_TIMEOUT)}])}this._requires_ack(wireMessage);this._schedule_message(wireMessage)};ClientImpl.prototype.unsubscribe=function(filter,unsubscribeOptions){this._trace("Client.unsubscribe",filter,unsubscribeOptions);if(!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));var wireMessage=new WireMessage(MESSAGE_TYPE.UNSUBSCRIBE);wireMessage.topics=[filter];if(unsubscribeOptions.onSuccess){wireMessage.callback=function(){unsubscribeOptions.onSuccess({invocationContext:unsubscribeOptions.invocationContext})}}if(unsubscribeOptions.timeout){wireMessage.timeOut=new Timeout(this,window,unsubscribeOptions.timeout,unsubscribeOptions.onFailure,[{invocationContext:unsubscribeOptions.invocationContext,errorCode:ERROR.UNSUBSCRIBE_TIMEOUT.code,errorMessage:format(ERROR.UNSUBSCRIBE_TIMEOUT)}])}this._requires_ack(wireMessage);this._schedule_message(wireMessage)};ClientImpl.prototype.send=function(message){this._trace("Client.send",message);if(!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));wireMessage=new WireMessage(MESSAGE_TYPE.PUBLISH);wireMessage.payloadMessage=message;if(message.qos>0)this._requires_ack(wireMessage);else if(this.onMessageDelivered)this._notify_msg_sent[wireMessage]=this.onMessageDelivered(wireMessage.payloadMessage);this._schedule_message(wireMessage)};ClientImpl.prototype.disconnect=function(){this._trace("Client.disconnect");if(!this.socket)throw new Error(format(ERROR.INVALID_STATE,["not connecting or connected"]));wireMessage=new WireMessage(MESSAGE_TYPE.DISCONNECT);this._notify_msg_sent[wireMessage]=scope(this._disconnected,this);this._schedule_message(wireMessage)};ClientImpl.prototype.getTraceLog=function(){if(this._traceBuffer!==null){this._trace("Client.getTraceLog",new Date);this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var key in this._sentMessages)this._trace("_sentMessages ",key,this._sentMessages[key]);for(var key in this._receivedMessages)this._trace("_receivedMessages ",key,this._receivedMessages[key]);return this._traceBuffer}};ClientImpl.prototype.startTrace=function(){if(this._traceBuffer===null){this._traceBuffer=[]}this._trace("Client.startTrace",new Date,version)};ClientImpl.prototype.stopTrace=function(){delete this._traceBuffer};ClientImpl.prototype._doConnect=function(wsurl){if(this.connectOptions.useSSL){var uriParts=wsurl.split(":");uriParts[0]="wss";wsurl=uriParts.join(":")}this.connected=false;if(this.connectOptions.mqttVersion<4){this.socket=new WebSocket(wsurl,["mqttv3.1"])}else{this.socket=new WebSocket(wsurl,["mqtt"])}this.socket.binaryType="arraybuffer";this.socket.onopen=scope(this._on_socket_open,this);this.socket.onmessage=scope(this._on_socket_message,this);this.socket.onerror=scope(this._on_socket_error,this);this.socket.onclose=scope(this._on_socket_close,this);this.sendPinger=new Pinger(this,window,this.connectOptions.keepAliveInterval);this.receivePinger=new Pinger(this,window,this.connectOptions.keepAliveInterval);this._connectTimeout=new Timeout(this,window,this.connectOptions.timeout,this._disconnected,[ERROR.CONNECT_TIMEOUT.code,format(ERROR.CONNECT_TIMEOUT)])};ClientImpl.prototype._schedule_message=function(message){this._msg_queue.push(message);if(this.connected){this._process_queue()}};ClientImpl.prototype.store=function(prefix,wireMessage){var storedMessage={type:wireMessage.type,messageIdentifier:wireMessage.messageIdentifier,version:1};switch(wireMessage.type){case MESSAGE_TYPE.PUBLISH:if(wireMessage.pubRecReceived)storedMessage.pubRecReceived=true;storedMessage.payloadMessage={};var hex="";var messageBytes=wireMessage.payloadMessage.payloadBytes;for(var i=0;i<messageBytes.length;i++){if(messageBytes[i]<=15)hex=hex+"0"+messageBytes[i].toString(16);else hex=hex+messageBytes[i].toString(16)}storedMessage.payloadMessage.payloadHex=hex;storedMessage.payloadMessage.qos=wireMessage.payloadMessage.qos;storedMessage.payloadMessage.destinationName=wireMessage.payloadMessage.destinationName;if(wireMessage.payloadMessage.duplicate)storedMessage.payloadMessage.duplicate=true;if(wireMessage.payloadMessage.retained)storedMessage.payloadMessage.retained=true;if(prefix.indexOf("Sent:")==0){if(wireMessage.sequence===undefined)wireMessage.sequence=++this._sequence;storedMessage.sequence=wireMessage.sequence}break;default:throw Error(format(ERROR.INVALID_STORED_DATA,[key,storedMessage]))}_localStorage.setItem(prefix+this._localKey+wireMessage.messageIdentifier,JSON.stringify(storedMessage))};ClientImpl.prototype.restore=function(key){var value=_localStorage.getItem(key);var storedMessage=JSON.parse(value);var wireMessage=new WireMessage(storedMessage.type,storedMessage);switch(storedMessage.type){case MESSAGE_TYPE.PUBLISH:var hex=storedMessage.payloadMessage.payloadHex;var buffer=new ArrayBuffer(hex.length/2);var byteStream=new Uint8Array(buffer);var i=0;while(hex.length>=2){var x=parseInt(hex.substring(0,2),16);hex=hex.substring(2,hex.length);byteStream[i++]=x}var payloadMessage=new Paho.MQTT.Message(byteStream);payloadMessage.qos=storedMessage.payloadMessage.qos;payloadMessage.destinationName=storedMessage.payloadMessage.destinationName;if(storedMessage.payloadMessage.duplicate)payloadMessage.duplicate=true;if(storedMessage.payloadMessage.retained)payloadMessage.retained=true;wireMessage.payloadMessage=payloadMessage;break;default:throw Error(format(ERROR.INVALID_STORED_DATA,[key,value]))}if(key.indexOf("Sent:"+this._localKey)==0){wireMessage.payloadMessage.duplicate=true;this._sentMessages[wireMessage.messageIdentifier]=wireMessage}else if(key.indexOf("Received:"+this._localKey)==0){this._receivedMessages[wireMessage.messageIdentifier]=wireMessage}};ClientImpl.prototype._process_queue=function(){var message=null;var fifo=this._msg_queue.reverse();while(message=fifo.pop()){this._socket_send(message);if(this._notify_msg_sent[message]){this._notify_msg_sent[message]();delete this._notify_msg_sent[message]}}};ClientImpl.prototype._requires_ack=function(wireMessage){var messageCount=Object.keys(this._sentMessages).length;if(messageCount>this.maxMessageIdentifier)throw Error("Too many messages:"+messageCount);while(this._sentMessages[this._message_identifier]!==undefined){this._message_identifier++}wireMessage.messageIdentifier=this._message_identifier;this._sentMessages[wireMessage.messageIdentifier]=wireMessage;if(wireMessage.type===MESSAGE_TYPE.PUBLISH){this.store("Sent:",wireMessage)}if(this._message_identifier===this.maxMessageIdentifier){this._message_identifier=1}};ClientImpl.prototype._on_socket_open=function(){var wireMessage=new WireMessage(MESSAGE_TYPE.CONNECT,this.connectOptions);wireMessage.clientId=this.clientId;this._socket_send(wireMessage)};ClientImpl.prototype._on_socket_message=function(event){this._trace("Client._on_socket_message",event.data);this.receivePinger.reset();var messages=this._deframeMessages(event.data);for(var i=0;i<messages.length;i+=1){this._handleMessage(messages[i])}};ClientImpl.prototype._deframeMessages=function(data){var byteArray=new Uint8Array(data);if(this.receiveBuffer){var newData=new Uint8Array(this.receiveBuffer.length+byteArray.length);newData.set(this.receiveBuffer);newData.set(byteArray,this.receiveBuffer.length);byteArray=newData;delete this.receiveBuffer}try{var offset=0;var messages=[];while(offset<byteArray.length){var result=decodeMessage(byteArray,offset);var wireMessage=result[0];offset=result[1];if(wireMessage!==null){messages.push(wireMessage)}else{break}}if(offset<byteArray.length){this.receiveBuffer=byteArray.subarray(offset)}}catch(error){this._disconnected(ERROR.INTERNAL_ERROR.code,format(ERROR.INTERNAL_ERROR,[error.message,error.stack.toString()]));return}return messages};ClientImpl.prototype._handleMessage=function(wireMessage){this._trace("Client._handleMessage",wireMessage);try{switch(wireMessage.type){case MESSAGE_TYPE.CONNACK:this._connectTimeout.cancel();if(this.connectOptions.cleanSession){for(var key in this._sentMessages){var sentMessage=this._sentMessages[key];_localStorage.removeItem("Sent:"+this._localKey+sentMessage.messageIdentifier)}this._sentMessages={};for(var key in this._receivedMessages){var receivedMessage=this._receivedMessages[key];_localStorage.removeItem("Received:"+this._localKey+receivedMessage.messageIdentifier)}this._receivedMessages={}}if(wireMessage.returnCode===0){this.connected=true;if(this.connectOptions.uris)this.hostIndex=this.connectOptions.uris.length}else{if(wireMessage.returnCode>0&&wireMessage.returnCode<=5){if(this.onError){this.onError({code:wireMessage.returnCode,msg:CONNACK_RC[wireMessage.returnCode]})}}this._disconnected(ERROR.CONNACK_RETURNCODE.code,format(ERROR.CONNACK_RETURNCODE,[wireMessage.returnCode,CONNACK_RC[wireMessage.returnCode]]));break}var sequencedMessages=new Array;for(var msgId in this._sentMessages){if(this._sentMessages.hasOwnProperty(msgId))sequencedMessages.push(this._sentMessages[msgId])}var sequencedMessages=sequencedMessages.sort(function(a,b){return a.sequence-b.sequence});for(var i=0,len=sequencedMessages.length;i<len;i++){var sentMessage=sequencedMessages[i];if(sentMessage.type==MESSAGE_TYPE.PUBLISH&&sentMessage.pubRecReceived){var pubRelMessage=new WireMessage(MESSAGE_TYPE.PUBREL,{messageIdentifier:sentMessage.messageIdentifier});this._schedule_message(pubRelMessage)}else{this._schedule_message(sentMessage)}}if(this.connectOptions.onSuccess){this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext})}this._process_queue();break;case MESSAGE_TYPE.PUBLISH:this._receivePublish(wireMessage);break;case MESSAGE_TYPE.PUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){delete this._sentMessages[wireMessage.messageIdentifier];_localStorage.removeItem("Sent:"+this._localKey+wireMessage.messageIdentifier);if(this.onMessageDelivered)this.onMessageDelivered(sentMessage.payloadMessage)}break;case MESSAGE_TYPE.PUBREC:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){sentMessage.pubRecReceived=true;var pubRelMessage=new WireMessage(MESSAGE_TYPE.PUBREL,{messageIdentifier:wireMessage.messageIdentifier});this.store("Sent:",sentMessage);this._schedule_message(pubRelMessage)}break;case MESSAGE_TYPE.PUBREL:var receivedMessage=this._receivedMessages[wireMessage.messageIdentifier];_localStorage.removeItem("Received:"+this._localKey+wireMessage.messageIdentifier);if(receivedMessage){this._receiveMessage(receivedMessage);delete this._receivedMessages[wireMessage.messageIdentifier]}var pubCompMessage=new WireMessage(MESSAGE_TYPE.PUBCOMP,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubCompMessage);break;case MESSAGE_TYPE.PUBCOMP:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];delete this._sentMessages[wireMessage.messageIdentifier];_localStorage.removeItem("Sent:"+this._localKey+wireMessage.messageIdentifier);if(this.onMessageDelivered)this.onMessageDelivered(sentMessage.payloadMessage);break;case MESSAGE_TYPE.SUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){if(sentMessage.timeOut)sentMessage.timeOut.cancel();wireMessage.returnCode.indexOf=Array.prototype.indexOf;if(wireMessage.returnCode.indexOf(128)!==-1){if(sentMessage.onFailure){sentMessage.onFailure(wireMessage.returnCode)}}else if(sentMessage.onSuccess){sentMessage.onSuccess(wireMessage.returnCode)}delete this._sentMessages[wireMessage.messageIdentifier]}break;case MESSAGE_TYPE.UNSUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){if(sentMessage.timeOut)sentMessage.timeOut.cancel();if(sentMessage.callback){sentMessage.callback()}delete this._sentMessages[wireMessage.messageIdentifier]}break;case MESSAGE_TYPE.PINGRESP:this.sendPinger.reset();break;case MESSAGE_TYPE.DISCONNECT:this._disconnected(ERROR.INVALID_MQTT_MESSAGE_TYPE.code,format(ERROR.INVALID_MQTT_MESSAGE_TYPE,[wireMessage.type]));break;default:this._disconnected(ERROR.INVALID_MQTT_MESSAGE_TYPE.code,format(ERROR.INVALID_MQTT_MESSAGE_TYPE,[wireMessage.type]))}}catch(error){this._disconnected(ERROR.INTERNAL_ERROR.code,format(ERROR.INTERNAL_ERROR,[error.message,error.stack.toString()]));return}};ClientImpl.prototype._on_socket_error=function(error){this._disconnected(ERROR.SOCKET_ERROR.code,format(ERROR.SOCKET_ERROR,[error.data]))};ClientImpl.prototype._on_socket_close=function(){
this._disconnected(ERROR.SOCKET_CLOSE.code,format(ERROR.SOCKET_CLOSE))};ClientImpl.prototype._socket_send=function(wireMessage){if(wireMessage.type==1){var wireMessageMasked=this._traceMask(wireMessage,"password");this._trace("Client._socket_send",wireMessageMasked)}else this._trace("Client._socket_send",wireMessage);this.socket.send(wireMessage.encode());this.sendPinger.reset()};ClientImpl.prototype._receivePublish=function(wireMessage){switch(wireMessage.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(wireMessage);break;case 1:var pubAckMessage=new WireMessage(MESSAGE_TYPE.PUBACK,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubAckMessage);this._receiveMessage(wireMessage);break;case 2:this._receivedMessages[wireMessage.messageIdentifier]=wireMessage;this.store("Received:",wireMessage);var pubRecMessage=new WireMessage(MESSAGE_TYPE.PUBREC,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubRecMessage);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos)}};ClientImpl.prototype._receiveMessage=function(wireMessage){if(this.onMessageArrived){this.onMessageArrived(wireMessage.payloadMessage)}};ClientImpl.prototype._disconnected=function(errorCode,errorText){this._trace("Client._disconnected",errorCode,errorText);this.sendPinger.cancel();this.receivePinger.cancel();if(this._connectTimeout)this._connectTimeout.cancel();this._msg_queue=[];this._notify_msg_sent={};if(this.socket){this.socket.onopen=null;this.socket.onmessage=null;this.socket.onerror=null;this.socket.onclose=null;if(this.socket.readyState===1)this.socket.close();delete this.socket}if(this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1){this.hostIndex++;this._doConnect(this.connectOptions.uris[this.hostIndex])}else{if(errorCode===undefined){errorCode=ERROR.OK.code;errorText=format(ERROR.OK)}if(this.connected){this.connected=false;if(this.onConnectionLost)this.onConnectionLost({errorCode:errorCode,errorMessage:errorText})}else{if(this.connectOptions.mqttVersion===4&&this.connectOptions.mqttVersionExplicit===false){this._trace("Failed to connect V4, dropping back to V3");this.connectOptions.mqttVersion=3;if(this.connectOptions.uris){this.hostIndex=0;this._doConnect(this.connectOptions.uris[0])}else{this._doConnect(this.uri)}}else if(this.connectOptions.onFailure){this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:errorCode,errorMessage:errorText})}}}};ClientImpl.prototype._trace=function(){if(this.traceFunction){for(var i in arguments){if(typeof arguments[i]!=="undefined")arguments[i]=JSON.stringify(arguments[i])}var record=Array.prototype.slice.call(arguments).join("");this.traceFunction({severity:"Debug",message:record})}if(this._traceBuffer!==null){for(var i=0,max=arguments.length;i<max;i++){if(this._traceBuffer.length==this._MAX_TRACE_ENTRIES){this._traceBuffer.shift()}if(i===0)this._traceBuffer.push(arguments[i]);else if(typeof arguments[i]==="undefined")this._traceBuffer.push(arguments[i]);else this._traceBuffer.push("  "+JSON.stringify(arguments[i]))}}};ClientImpl.prototype._traceMask=function(traceObject,masked){var traceObjectMasked={};for(var attr in traceObject){if(traceObject.hasOwnProperty(attr)){if(attr==masked)traceObjectMasked[attr]="******";else traceObjectMasked[attr]=traceObject[attr]}}return traceObjectMasked};var Client=function(host,port,path,clientId){var uri;if(typeof host!=="string")throw new Error(format(ERROR.INVALID_TYPE,[typeof host,"host"]));if(arguments.length==2){clientId=port;uri=host;var match=uri.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(match){host=match[4]||match[2];port=parseInt(match[7]);path=match[8]}else{throw new Error(format(ERROR.INVALID_ARGUMENT,[host,"host"]))}}else{if(arguments.length==3){clientId=path;path="/mqtt"}if(typeof port!=="number"||port<0)throw new Error(format(ERROR.INVALID_TYPE,[typeof port,"port"]));if(typeof path!=="string")throw new Error(format(ERROR.INVALID_TYPE,[typeof path,"path"]));var ipv6AddSBracket=host.indexOf(":")!=-1&&host.slice(0,1)!="["&&host.slice(-1)!="]";uri="ws://"+(ipv6AddSBracket?"["+host+"]":host)+":"+port+path}var clientIdLength=0;for(var i=0;i<clientId.length;i++){var charCode=clientId.charCodeAt(i);if(55296<=charCode&&charCode<=56319){i++}clientIdLength++}if(typeof clientId!=="string"||clientIdLength>65535)throw new Error(format(ERROR.INVALID_ARGUMENT,[clientId,"clientId"]));var client=new ClientImpl(uri,host,port,path,clientId);this._getHost=function(){return host};this._setHost=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getPort=function(){return port};this._setPort=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getPath=function(){return path};this._setPath=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getURI=function(){return uri};this._setURI=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getClientId=function(){return client.clientId};this._setClientId=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))};this._getOnConnectionLost=function(){return client.onConnectionLost};this._setOnConnectionLost=function(newOnConnectionLost){if(typeof newOnConnectionLost==="function")client.onConnectionLost=newOnConnectionLost;else throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnConnectionLost,"onConnectionLost"]))};this._getOnMessageDelivered=function(){return client.onMessageDelivered};this._setOnMessageDelivered=function(newOnMessageDelivered){if(typeof newOnMessageDelivered==="function")client.onMessageDelivered=newOnMessageDelivered;else throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnMessageDelivered,"onMessageDelivered"]))};this._getOnMessageArrived=function(){return client.onMessageArrived};this._setOnMessageArrived=function(newOnMessageArrived){if(typeof newOnMessageArrived==="function")client.onMessageArrived=newOnMessageArrived;else throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnMessageArrived,"onMessageArrived"]))};this._getOnError=function(){return client.onError};this._setOnError=function(newOnError){if(typeof newOnError==="function")client.onError=newOnError;else throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnError,"onError"]))};this._getTrace=function(){return client.traceFunction};this._setTrace=function(trace){if(typeof trace==="function"){client.traceFunction=trace}else{throw new Error(format(ERROR.INVALID_TYPE,[typeof trace,"onTrace"]))}};this.connect=function(connectOptions){connectOptions=connectOptions||{};validate(connectOptions,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",mqttVersion:"number"});if(connectOptions.keepAliveInterval===undefined)connectOptions.keepAliveInterval=60;if(connectOptions.mqttVersion>4||connectOptions.mqttVersion<3){throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.mqttVersion,"connectOptions.mqttVersion"]))}if(connectOptions.mqttVersion===undefined){connectOptions.mqttVersionExplicit=false;connectOptions.mqttVersion=4}else{connectOptions.mqttVersionExplicit=true}if(connectOptions.password===undefined&&connectOptions.userName!==undefined)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.password,"connectOptions.password"]));if(connectOptions.willMessage){if(!(connectOptions.willMessage instanceof Message))throw new Error(format(ERROR.INVALID_TYPE,[connectOptions.willMessage,"connectOptions.willMessage"]));connectOptions.willMessage.stringPayload;if(typeof connectOptions.willMessage.destinationName==="undefined")throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.willMessage.destinationName,"connectOptions.willMessage.destinationName"]))}if(typeof connectOptions.cleanSession==="undefined")connectOptions.cleanSession=true;if(connectOptions.hosts){if(!(connectOptions.hosts instanceof Array))throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts,"connectOptions.hosts"]));if(connectOptions.hosts.length<1)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts,"connectOptions.hosts"]));var usingURIs=false;for(var i=0;i<connectOptions.hosts.length;i++){if(typeof connectOptions.hosts[i]!=="string")throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(connectOptions.hosts[i])){if(i==0){usingURIs=true}else if(!usingURIs){throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]))}}else if(usingURIs){throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]))}}if(!usingURIs){if(!connectOptions.ports)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));if(!(connectOptions.ports instanceof Array))throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));if(connectOptions.hosts.length!=connectOptions.ports.length)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));connectOptions.uris=[];for(var i=0;i<connectOptions.hosts.length;i++){if(typeof connectOptions.ports[i]!=="number"||connectOptions.ports[i]<0)throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.ports[i],"connectOptions.ports["+i+"]"]));var host=connectOptions.hosts[i];var port=connectOptions.ports[i];var ipv6=host.indexOf(":")!=-1;uri="ws://"+(ipv6?"["+host+"]":host)+":"+port+path;connectOptions.uris.push(uri)}}else{connectOptions.uris=connectOptions.hosts}}client.connect(connectOptions)};this.subscribe=function(filter,subscribeOptions){if(typeof filter!=="string")throw new Error("Invalid argument:"+filter);subscribeOptions=subscribeOptions||{};validate(subscribeOptions,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(subscribeOptions.timeout&&!subscribeOptions.onFailure)throw new Error("subscribeOptions.timeout specified with no onFailure callback.");if(typeof subscribeOptions.qos!=="undefined"&&!(subscribeOptions.qos===0||subscribeOptions.qos===1||subscribeOptions.qos===2))throw new Error(format(ERROR.INVALID_ARGUMENT,[subscribeOptions.qos,"subscribeOptions.qos"]));client.subscribe(filter,subscribeOptions)};this.unsubscribe=function(filter,unsubscribeOptions){if(typeof filter!=="string")throw new Error("Invalid argument:"+filter);unsubscribeOptions=unsubscribeOptions||{};validate(unsubscribeOptions,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"});if(unsubscribeOptions.timeout&&!unsubscribeOptions.onFailure)throw new Error("unsubscribeOptions.timeout specified with no onFailure callback.");client.unsubscribe(filter,unsubscribeOptions)};this.send=function(topic,payload,qos,retained){var message;if(arguments.length==0){throw new Error("Invalid argument."+"length")}else if(arguments.length==1){if(!(topic instanceof Message)&&typeof topic!=="string")throw new Error("Invalid argument:"+typeof topic);message=topic;if(typeof message.destinationName==="undefined")throw new Error(format(ERROR.INVALID_ARGUMENT,[message.destinationName,"Message.destinationName"]));client.send(message)}else{message=new Message(payload);message.destinationName=topic;if(arguments.length>=3)message.qos=qos;if(arguments.length>=4)message.retained=retained;client.send(message)}};this.disconnect=function(){client.disconnect()};this.getTraceLog=function(){return client.getTraceLog()};this.startTrace=function(){client.startTrace()};this.stopTrace=function(){client.stopTrace()};this.isConnected=function(){return client.connected}};Client.prototype={get host(){return this._getHost()},set host(newHost){this._setHost(newHost)},get port(){return this._getPort()},set port(newPort){this._setPort(newPort)},get path(){return this._getPath()},set path(newPath){this._setPath(newPath)},get clientId(){return this._getClientId()},set clientId(newClientId){this._setClientId(newClientId)},get onConnectionLost(){return this._getOnConnectionLost()},set onConnectionLost(newOnConnectionLost){this._setOnConnectionLost(newOnConnectionLost)},get onMessageDelivered(){return this._getOnMessageDelivered()},set onMessageDelivered(newOnMessageDelivered){this._setOnMessageDelivered(newOnMessageDelivered)},get onMessageArrived(){return this._getOnMessageArrived()},set onMessageArrived(newOnMessageArrived){this._setOnMessageArrived(newOnMessageArrived)},get onError(){return this._getOnError()},set onError(newOnError){this._setOnError(newOnError)},get trace(){return this._getTrace()},set trace(newTraceFunction){this._setTrace(newTraceFunction)}};var Message=function(newPayload){var payload;if(typeof newPayload==="string"||newPayload instanceof ArrayBuffer||newPayload instanceof Int8Array||newPayload instanceof Uint8Array||newPayload instanceof Int16Array||newPayload instanceof Uint16Array||newPayload instanceof Int32Array||newPayload instanceof Uint32Array||newPayload instanceof Float32Array||newPayload instanceof Float64Array){payload=newPayload}else{throw format(ERROR.INVALID_ARGUMENT,[newPayload,"newPayload"])}this._getPayloadString=function(){if(typeof payload==="string")return payload;else return parseUTF8(payload,0,payload.length)};this._getPayloadBytes=function(){if(typeof payload==="string"){var buffer=new ArrayBuffer(UTF8Length(payload));var byteStream=new Uint8Array(buffer);stringToUTF8(payload,byteStream,0);return byteStream}else{return payload}};var destinationName=undefined;this._getDestinationName=function(){return destinationName};this._setDestinationName=function(newDestinationName){if(typeof newDestinationName==="string")destinationName=newDestinationName;else throw new Error(format(ERROR.INVALID_ARGUMENT,[newDestinationName,"newDestinationName"]))};var qos=0;this._getQos=function(){return qos};this._setQos=function(newQos){if(newQos===0||newQos===1||newQos===2)qos=newQos;else throw new Error("Invalid argument:"+newQos)};var retained=false;this._getRetained=function(){return retained};this._setRetained=function(newRetained){if(typeof newRetained==="boolean")retained=newRetained;else throw new Error(format(ERROR.INVALID_ARGUMENT,[newRetained,"newRetained"]))};var duplicate=false;this._getDuplicate=function(){return duplicate};this._setDuplicate=function(newDuplicate){duplicate=newDuplicate}};Message.prototype={get payloadString(){return this._getPayloadString()},get payloadBytes(){return this._getPayloadBytes()},get destinationName(){return this._getDestinationName()},set destinationName(newDestinationName){this._setDestinationName(newDestinationName)},get qos(){return this._getQos()},set qos(newQos){this._setQos(newQos)},get retained(){return this._getRetained()},set retained(newRetained){this._setRetained(newRetained)},get duplicate(){return this._getDuplicate()},set duplicate(newDuplicate){this._setDuplicate(newDuplicate)}};return{Client:Client,Message:Message}}(window);if(typeof module!=="undefined"&&typeof exports!=="undefined"){module.exports=OAuth;var CryptoJS=require("crypto-js")}function OAuth(opts){if(!(this instanceof OAuth)){return new OAuth(opts)}if(!opts){opts={}}if(!opts.consumer){throw new Error("consumer option is required")}this.consumer=opts.consumer;this.signature_method=opts.signature_method||"HMAC-SHA1";this.nonce_length=opts.nonce_length||32;this.version=opts.version||"1.0";this.parameter_seperator=opts.parameter_seperator||", ";if(typeof opts.last_ampersand==="undefined"){this.last_ampersand=true}else{this.last_ampersand=opts.last_ampersand}switch(this.signature_method){case"HMAC-SHA1":this.hash=function(base_string,key){return CryptoJS.HmacSHA1(base_string,key).toString(CryptoJS.enc.Base64)};break;case"HMAC-SHA256":this.hash=function(base_string,key){return CryptoJS.HmacSHA256(base_string,key).toString(CryptoJS.enc.Base64)};break;case"PLAINTEXT":this.hash=function(base_string,key){return key};break;case"RSA-SHA1":throw new Error("oauth-1.0a does not support this signature method right now. Coming Soon...");default:throw new Error("The OAuth 1.0a protocol defines three signature methods: HMAC-SHA1, RSA-SHA1, and PLAINTEXT only")}}OAuth.prototype.authorize=function(request,token){var oauth_data={oauth_consumer_key:this.consumer.public,oauth_nonce:this.getNonce(),oauth_signature_method:this.signature_method,oauth_timestamp:this.getTimeStamp(),oauth_version:this.version};if(!token){token={}}if(token.public){oauth_data.oauth_token=token.public}if(!request.data){request.data={}}oauth_data.oauth_signature=this.getSignature(request,token.secret,oauth_data);return oauth_data};OAuth.prototype.getSignature=function(request,token_secret,oauth_data){return this.hash(this.getBaseString(request,oauth_data),this.getSigningKey(token_secret))};OAuth.prototype.getBaseString=function(request,oauth_data){return request.method.toUpperCase()+"&"+this.percentEncode(this.getBaseUrl(request.url))+"&"+this.percentEncode(this.getParameterString(request,oauth_data))};OAuth.prototype.getParameterString=function(request,oauth_data){var base_string_data=this.sortObject(this.percentEncodeData(this.mergeObject(oauth_data,this.mergeObject(request.data,this.deParamUrl(request.url)))));var data_str="";for(var key in base_string_data){data_str+=key+"="+base_string_data[key]+"&"}data_str=data_str.substr(0,data_str.length-1);return data_str};OAuth.prototype.getSigningKey=function(token_secret){token_secret=token_secret||"";if(!this.last_ampersand&&!token_secret){return this.percentEncode(this.consumer.secret)}return this.percentEncode(this.consumer.secret)+"&"+this.percentEncode(token_secret)};OAuth.prototype.getBaseUrl=function(url){return url.split("?")[0]};OAuth.prototype.deParam=function(string){var arr=decodeURIComponent(string).split("&");var data={};for(var i=0;i<arr.length;i++){var item=arr[i].split("=");data[item[0]]=item[1]}return data};OAuth.prototype.deParamUrl=function(url){var tmp=url.split("?");if(tmp.length===1)return{};return this.deParam(tmp[1])};OAuth.prototype.percentEncode=function(str){return encodeURIComponent(str).replace(/\!/g,"%21").replace(/\*/g,"%2A").replace(/\'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29")};OAuth.prototype.percentEncodeData=function(data){var result={};for(var key in data){result[this.percentEncode(key)]=this.percentEncode(data[key])}return result};OAuth.prototype.toHeader=function(oauth_data){oauth_data=this.sortObject(oauth_data);var header_value="OAuth ";for(var key in oauth_data){if(key.indexOf("oauth_")===-1)continue;header_value+=this.percentEncode(key)+'="'+this.percentEncode(oauth_data[key])+'"'+this.parameter_seperator}return{Authorization:header_value.substr(0,header_value.length-this.parameter_seperator.length)}};OAuth.prototype.getNonce=function(len){var word_characters="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";var result="";if(!len)len=this.nonce_length;for(var i=0;i<len;i++){result+=word_characters[parseInt(Math.random()*word_characters.length,10)]}return result};OAuth.prototype.getTimeStamp=function(){return parseInt((new Date).getTime()/1e3,10)};OAuth.prototype.mergeObject=function(obj1,obj2){var merged_obj=obj1;for(var key in obj2){merged_obj[key]=obj2[key]}return merged_obj};OAuth.prototype.sortObject=function(data){var keys=Object.keys(data);var result={};keys.sort();for(var i=0;i<keys.length;i++){var key=keys[i];result[key]=data[key]}return result};var CryptoJS=CryptoJS||function(g,l){var e={},d=e.lib={},m=function(){},k=d.Base={extend:function(a){m.prototype=this;var c=new m;a&&c.mixIn(a);c.hasOwnProperty("init")||(c.init=function(){c.$super.init.apply(this,arguments)});c.init.prototype=c;c.$super=this;return c},create:function(){var a=this.extend();a.init.apply(a,arguments);return a},init:function(){},mixIn:function(a){for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},p=d.WordArray=k.extend({init:function(a,c){a=this.words=a||[];this.sigBytes=c!=l?c:4*a.length},toString:function(a){return(a||n).stringify(this)},concat:function(a){var c=this.words,q=a.words,f=this.sigBytes;a=a.sigBytes;this.clamp();if(f%4)for(var b=0;b<a;b++)c[f+b>>>2]|=(q[b>>>2]>>>24-8*(b%4)&255)<<24-8*((f+b)%4);else if(65535<q.length)for(b=0;b<a;b+=4)c[f+b>>>2]=q[b>>>2];else c.push.apply(c,q);this.sigBytes+=a;return this},clamp:function(){var a=this.words,c=this.sigBytes;a[c>>>2]&=4294967295<<32-8*(c%4);a.length=g.ceil(c/4)},clone:function(){var a=k.clone.call(this);a.words=this.words.slice(0);return a},random:function(a){for(var c=[],b=0;b<a;b+=4)c.push(4294967296*g.random()|0);return new p.init(c,a)}}),b=e.enc={},n=b.Hex={stringify:function(a){var c=a.words;a=a.sigBytes;for(var b=[],f=0;f<a;f++){var d=c[f>>>2]>>>24-8*(f%4)&255;b.push((d>>>4).toString(16));b.push((d&15).toString(16))}return b.join("")},parse:function(a){for(var c=a.length,b=[],f=0;f<c;f+=2)b[f>>>3]|=parseInt(a.substr(f,2),16)<<24-4*(f%8);return new p.init(b,c/2)}},j=b.Latin1={stringify:function(a){var c=a.words;a=a.sigBytes;for(var b=[],f=0;f<a;f++)b.push(String.fromCharCode(c[f>>>2]>>>24-8*(f%4)&255));return b.join("")},parse:function(a){for(var c=a.length,b=[],f=0;f<c;f++)b[f>>>2]|=(a.charCodeAt(f)&255)<<24-8*(f%4);return new p.init(b,c)}},h=b.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(c){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},r=d.BufferedBlockAlgorithm=k.extend({reset:function(){this._data=new p.init;this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=h.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(a){var c=this._data,b=c.words,f=c.sigBytes,d=this.blockSize,e=f/(4*d),e=a?g.ceil(e):g.max((e|0)-this._minBufferSize,0);a=e*d;f=g.min(4*a,f);if(a){for(var k=0;k<a;k+=d)this._doProcessBlock(b,k);k=b.splice(0,a);c.sigBytes-=f}return new p.init(k,f)},clone:function(){var a=k.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});d.Hasher=r.extend({cfg:k.extend(),init:function(a){this.cfg=this.cfg.extend(a);this.reset()},reset:function(){r.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);return this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,d){return new a.init(d).finalize(b)}},_createHmacHelper:function(a){return function(b,d){return new s.HMAC.init(a,d).finalize(b)}}});var s=e.algo={};return e}(Math);(function(){var g=CryptoJS,l=g.lib,e=l.WordArray,d=l.Hasher,m=[],l=g.algo.SHA1=d.extend({_doReset:function(){this._hash=new e.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(d,e){for(var b=this._hash.words,n=b[0],j=b[1],h=b[2],g=b[3],l=b[4],a=0;80>a;a++){if(16>a)m[a]=d[e+a]|0;else{var c=m[a-3]^m[a-8]^m[a-14]^m[a-16];m[a]=c<<1|c>>>31}c=(n<<5|n>>>27)+l+m[a];c=20>a?c+((j&h|~j&g)+1518500249):40>a?c+((j^h^g)+1859775393):60>a?c+((j&h|j&g|h&g)-1894007588):c+((j^h^g)-899497514);l=g;g=h;h=j<<30|j>>>2;j=n;n=c}b[0]=b[0]+n|0;b[1]=b[1]+j|0;b[2]=b[2]+h|0;b[3]=b[3]+g|0;b[4]=b[4]+l|0},_doFinalize:function(){var d=this._data,e=d.words,b=8*this._nDataBytes,g=8*d.sigBytes;e[g>>>5]|=128<<24-g%32;e[(g+64>>>9<<4)+14]=Math.floor(b/4294967296);e[(g+64>>>9<<4)+15]=b;d.sigBytes=4*e.length;this._process();return this._hash},clone:function(){var e=d.clone.call(this);e._hash=this._hash.clone();return e}});g.SHA1=d._createHelper(l);g.HmacSHA1=d._createHmacHelper(l)})();(function(){var g=CryptoJS,l=g.enc.Utf8;g.algo.HMAC=g.lib.Base.extend({init:function(e,d){e=this._hasher=new e.init;"string"==typeof d&&(d=l.parse(d));var g=e.blockSize,k=4*g;d.sigBytes>k&&(d=e.finalize(d));d.clamp();for(var p=this._oKey=d.clone(),b=this._iKey=d.clone(),n=p.words,j=b.words,h=0;h<g;h++)n[h]^=1549556828,j[h]^=909522486;p.sigBytes=b.sigBytes=k;this.reset()},reset:function(){var e=this._hasher;e.reset();e.update(this._iKey)},update:function(e){this._hasher.update(e);return this},finalize:function(e){var d=this._hasher;e=d.finalize(e);d.reset();return d.finalize(this._oKey.clone().concat(e))}})})();(function(){var h=CryptoJS,j=h.lib.WordArray;h.enc.Base64={stringify:function(b){var e=b.words,f=b.sigBytes,c=this._map;b.clamp();b=[];for(var a=0;a<f;a+=3)for(var d=(e[a>>>2]>>>24-8*(a%4)&255)<<16|(e[a+1>>>2]>>>24-8*((a+1)%4)&255)<<8|e[a+2>>>2]>>>24-8*((a+2)%4)&255,g=0;4>g&&a+.75*g<f;g++)b.push(c.charAt(d>>>6*(3-g)&63));if(e=c.charAt(64))for(;b.length%4;)b.push(e);return b.join("")},parse:function(b){var e=b.length,f=this._map,c=f.charAt(64);c&&(c=b.indexOf(c),-1!=c&&(e=c));for(var c=[],a=0,d=0;d<e;d++)if(d%4){var g=f.indexOf(b.charAt(d-1))<<2*(d%4),h=f.indexOf(b.charAt(d))>>>6-2*(d%4);c[a>>>2]|=(g|h)<<24-8*(a%4);a++}return j.create(c,a)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();(function(b){function a(b,d){if({}.hasOwnProperty.call(a.cache,b))return a.cache[b];var e=a.resolve(b);if(!e)throw new Error("Failed to resolve module "+b);var c={id:b,require:a,filename:b,exports:{},loaded:!1,parent:d,children:[]};d&&d.children.push(c);var f=b.slice(0,b.lastIndexOf("/")+1);return a.cache[b]=c.exports,e.call(c.exports,c,c.exports,f,b),c.loaded=!0,a.cache[b]=c.exports}a.modules={},a.cache={},a.resolve=function(b){return{}.hasOwnProperty.call(a.modules,b)?a.modules[b]:void 0},a.define=function(b,c){a.modules[b]=c},a.define("/index.js",function(c,d,e,f){function b(){b.init.call(this)}var a={};a.isObject=function a(b){return typeof b==="object"&&b!==null},a.isNumber=function a(b){return typeof b==="number"},a.isUndefined=function a(b){return b===void 0},a.isFunction=function a(b){return typeof b==="function"},c.exports=b,b.EventEmitter=b,b.prototype._events=undefined,b.prototype._maxListeners=undefined,b.defaultMaxListeners=10,b.init=function(){this._events=this._events||{},this._maxListeners=this._maxListeners||undefined},b.prototype.setMaxListeners=function(b){if(!a.isNumber(b)||b<0||isNaN(b))throw TypeError("n must be a positive number");return this._maxListeners=b,this},b.prototype.emit=function(h){var f,c,d,e,b,g;if(this._events||(this._events={}),h==="error"&&!this._events.error&&false)throw f=arguments[1],f instanceof Error?f:Error('Uncaught, unspecified "error" event.');if(c=this._events[h],a.isUndefined(c))return!1;if(a.isFunction(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:d=arguments.length;e=new Array(d-1);for(b=1;b<d;b++)e[b-1]=arguments[b];c.apply(this,e)}else if(a.isObject(c)){for(d=arguments.length,e=new Array(d-1),b=1;b<d;b++)e[b-1]=arguments[b];for(g=c.slice(),d=g.length,b=0;b<d;b++)g[b].apply(this,e)}return!0},b.prototype.addListener=function(c,d){var e;if(!a.isFunction(d))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",c,a.isFunction(d.listener)?d.listener:d),this._events[c]?a.isObject(this._events[c])?this._events[c].push(d):this._events[c]=[this._events[c],d]:this._events[c]=d,a.isObject(this._events[c])&&!this._events[c].warned){var e;a.isUndefined(this._maxListeners)?e=b.defaultMaxListeners:e=this._maxListeners,e&&e>0&&this._events[c].length>e&&(this._events[c].warned=!0,a.isFunction(console.error)&&console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[c].length),a.isFunction(console.trace)&&console.trace())}return this},b.prototype.on=b.prototype.addListener,b.prototype.once=function(e,b){function c(){this.removeListener(e,c),d||(d=!0,b.apply(this,arguments))}if(!a.isFunction(b))throw TypeError("listener must be a function");var d=!1;return c.listener=b,this.on(e,c),this},b.prototype.removeListener=function(d,c){var b,f,g,e;if(!a.isFunction(c))throw TypeError("listener must be a function");if(!(this._events&&this._events[d]))return this;if(b=this._events[d],g=b.length,f=-1,b===c||a.isFunction(b.listener)&&b.listener===c)delete this._events[d],this._events.removeListener&&this.emit("removeListener",d,c);else if(a.isObject(b)){for(e=g;e-- >0;)if(b[e]===c||b[e].listener&&b[e].listener===c){f=e;break}if(f<0)return this;b.length===1?(b.length=0,delete this._events[d]):b.splice(f,1),this._events.removeListener&&this.emit("removeListener",d,c)}return this},b.prototype.removeAllListeners=function(c){var d,b;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[c]&&delete this._events[c],this;if(arguments.length===0){for(d in this._events){if(d==="removeListener")continue;this.removeAllListeners(d)}return this.removeAllListeners("removeListener"),this._events={},this}if(b=this._events[c],a.isFunction(b))this.removeListener(c,b);else if(Array.isArray(b))while(b.length)this.removeListener(c,b[b.length-1]);return delete this._events[c],this},b.prototype.listeners=function(b){var c;return this._events&&this._events[b]?a.isFunction(this._events[b])?c=[this._events[b]]:c=this._events[b].slice():c=[],c},b.listenerCount=function(b,d){var c;return b._events&&b._events[d]?a.isFunction(b._events[d])?c=1:c=b._events[d].length:c=0,c}}),b.EventEmitter=a("/index.js")}).call(this,this);if(typeof Microgear==="undefined"){Microgear={}}Microgear.create=function(param){var gkey=param.key||param.gearkey||"";var gsecret=param.secret||param.gearsecret||"";var galias=param.alias||param.gearalias||"";if(!param)return;var scope=param.scope;var self=null;var _microgear=function(gearkey,gearsecret,gearalias){this.securemode=USETLS;this.gearkey=gearkey;this.gearsecret=gearsecret;this.gearalias=gearalias?gearalias.substring(0,16):null;this.client=null;this.subscriptions=[];this.messageBuffer=[];this.requesttoken={};this.accesstoken={}};var bucket={};var storage={get:function(key){if(storejs.enabled)return storejs.get(key);else return bucket[key]},set:function(key,val){if(storejs.enabled)storejs.set(key,val);else bucket[key]=val}};function extract(response){var out={};var arr=response.split("&");for(var i=0;i<arr.length;i++){var a=arr[i].split("=");out[a[0]]=a[1]}return out}function validateLocalStorage(){return true}function jsonparse(jsontext){var jsonobj;try{jsonobj=JSON.parse(jsontext)}catch(e){return null}return jsonobj}function createCORSRequest(method,url){var xhr=new XMLHttpRequest;if("withCredentials"in xhr){xhr.open(method,url,true)}else if(typeof XDomainRequest!="undefined"){xhr=new XDomainRequest;xhr.open(method,url)}else{xhr=null}return xhr}_microgear.prototype=new EventEmitter;_microgear.prototype.createtoken=function(callback){var oauth=OAuth({consumer:{public:self.gearkey,secret:self.gearsecret},signature_method:"HMAC-SHA1"});if(validateLocalStorage()&&(!self.accesstoken||!self.accesstoken.token)){var skey=storage.get("microgear."+self.gearkey+".key");if(skey&&skey!=self.gearkey){self.resettoken()}self.accesstoken=jsonparse(storage.get("microgear."+self.gearkey+".accesstoken"))}if(self.accesstoken&&self.accesstoken.token&&self.accesstoken.secret&&self.accesstoken.endpoint){if(typeof callback=="function")callback(3)}else{var gearauthurl;if(self.securemode)gearauthurl="https://"+GEARAUTH+":"+GEARAPISECUREPORT;else gearauthurl="http://"+GEARAUTH+":"+GEARAPIPORT;if(!self.requesttoken&&validateLocalStorage()){var skey=storage.get("microgear."+self.gearkey+".key");if(skey&&skey!=self.gearkey){self.resettoken()}self.requesttoken=jsonparse(storage.get("microgear."+self.gearkey+".requesttoken"))}if(self.requesttoken&&self.requesttoken.token&&self.requesttoken.secret){var request_data={url:gearauthurl+"/api/atoken",method:"POST",data:{oauth_verifier:self.requesttoken.verifier}};var http=createCORSRequest(request_data.method,request_data.url);if(!http){
throw new Error("CORS not supported")}var reqtok={public:self.requesttoken.token,secret:self.requesttoken.secret};http.setRequestHeader("Authorization",oauth.toHeader(oauth.authorize(request_data,reqtok)).Authorization);http.send();http.onreadystatechange=function(){if(http.readyState==4){switch(http.status){case 200:var r=extract(http.responseText);self.accesstoken={};self.accesstoken.token=r.oauth_token;self.accesstoken.secret=r.oauth_token_secret;self.accesstoken.endpoint=unescape(r.endpoint);var hkey=self.accesstoken.secret+"&"+self.gearsecret;var revokecode=CryptoJS.HmacSHA1(self.accesstoken.token,hkey).toString(CryptoJS.enc.Base64).replace(/\//g,"_");self.accesstoken.revokecode=unescape(revokecode);if(r.flag!="S"){if(validateLocalStorage()){storage.set("microgear."+self.gearkey+".key",self.gearkey);storage.set("microgear."+self.gearkey+".accesstoken",JSON.stringify(self.accesstoken))}}if(typeof callback=="function")callback(2);break;case 401:self.emit("error",{code:401,message:"Not authorized"});if(callback)callback(1);break;case 500:self.emit("error",{status:500,message:"Request token invalid"});if(typeof callback=="function")callback(0);break;default:self.emit("error",{status:503,message:"Cannot obtain a token"});if(typeof callback=="function")callback(0);break}}}}else{var verifier;if(this.gearalias)verifier=this.gearalias;else verifier=MGREV;var request_data={url:gearauthurl+"/api/rtoken",method:"POST",data:{oauth_callback:"scope=&appid="+self.appid+"&mgrev="+MGREV+"&verifier="+verifier}};var http=createCORSRequest(request_data.method,request_data.url);if(!http){throw new Error("CORS not supported")}http.setRequestHeader("Authorization",oauth.toHeader(oauth.authorize(request_data)).Authorization);http.send();http.onreadystatechange=function(){if(http.readyState==4){switch(http.status){case 200:var r=extract(http.responseText);self.requesttoken={};self.requesttoken.token=r.oauth_token;self.requesttoken.secret=r.oauth_token_secret;self.requesttoken.verifier=verifier;if(validateLocalStorage()){storage.set("microgear."+self.gearkey+".requesttoken",JSON.stringify(self.requesttoken))}if(typeof callback=="function")callback(1);break;default:self.emit("error",{status:503,message:"Cannot obtain a token"});if(typeof callback=="function")callback(0);break}}}}}};_microgear.prototype.brokerconnect=function(callback){var hkey=self.accesstoken.secret+"&"+self.gearsecret;var mqttusername=self.gearkey+"%"+Math.floor(Date.now()/1e3);var mqttpassword=CryptoJS.HmacSHA1(self.accesstoken.token+"%"+mqttusername,hkey).toString(CryptoJS.enc.Base64);var b=self.accesstoken.endpoint.substr(6).split(":");var wsport;if(self.securemode)wsport=GBWSSPORT;else wsport=GBWSPORT;self.client=new Paho.MQTT.Client(b[0],Number(wsport),self.accesstoken.token);self.client.onConnectionLost=_onConnectionLost;self.client.onMessageArrived=_onMessageArrived;self.client.onError=_onError;self.client.connect({userName:mqttusername,password:mqttpassword,useSSL:self.securemode,onSuccess:_onConnect})};function initiateconnection(done){self.lastretryconnection=Date.now();self.createtoken(function(state){self.mgstate=state;switch(state){case 0:if(self.appkey||self.secret)throw new Error("Error: request token is not issued, please check your appkey and appsecret");else throw new Error("Error: request token is not issued, please check your consumerkey and consumersecret");return;case 1:initiateconnection(done);return;case 2:initiateconnection(done);return;case 3:self.brokerconnect(function(){if(done)done()});return}})}function _onConnect(){for(var i=0;i<self.subscriptions.length;i++){if(self.debugmode)console.log("auto subscribe "+self.subscriptions[i]);self.client.subscribe("/"+self.appid+self.subscriptions[i])}self.client.subscribe("/&id/"+self.clientid+"/#");if(self.listeners("present")){self.client.subscribe("/"+self.appid+"/&present")}if(self.listeners("absent")){self.client.subscribe("/"+self.appid+"/&absent")}if(self.gearalias){self.setalias(self.gearalias)}self.emit("connected");var timer=setInterval(function(){if(self.messageBuffer.length>0){var message=self.messageBuffer.shift();message.destinationName="/"+self.appid+message.destinationName;self.client.send(message)}else clearInterval(timer)},200)}function _onError(err){if(err.code==4){self.emit("info","invalid token, requesting a new one");if(validateLocalStorage()){self.requesttoken={};self.accesstoken={};storage.set("microgear."+self.gearkey+".key","");storage.set("microgear."+self.gearkey+".accesstoken",JSON.stringify({}));storage.set("microgear."+self.gearkey+".requesttoken",JSON.stringify({}))}}}function _onMessageArrived(msg){var topic=msg.destinationName;var message=msg.payloadString;var plen=self.appid.length+1;var rtop=topic.substr(plen,topic.length-plen);if(rtop.substr(0,2)=="/&"){var p=(rtop.substr(1,rtop.length-1)+"/").indexOf("/");var ctop=rtop.substr(2,p);switch(ctop){case"present":case"absent":var pm;try{pm=JSON.parse(message.toString())}catch(e){pm=message.toString()}self.emit(ctop,pm);break;case"resetendpoint":if(self.accesstoken&&self.accesstoken.endpoint){self.accesstoken.endpoint="";storage.set("microgear."+self.gearkey+".accesstoken",JSON.stringify(self.accesstoken));self.emit("info","endpoint reset")}break}}else if(topic.substr(0,1)=="@"){switch(topic){case"@info":self.emit("info",message);break;case"@error":self.emit("error",message);break}}else{self.emit("message",topic,message)}}function _onConnectionLost(responseObject){self.emit("disconnected")}function monloop(){if(self&&self.onlinemode&&self.client&&!self.client.isConnected()){if(Date.now()-self.lastretryconnection>RETRYCONNECTIONINTERVAL){self.lastretryconnection=Date.now();initiateconnection(function(){})}}}setInterval(monloop,MONLOOPINTERVAL);_microgear.prototype.connect=function(_appid,done){this.onlinemode=true;self.appid=_appid;initiateconnection(done)};_microgear.prototype.disconnect=function(){this.onlinemode=false;self.client.disconnect()};_microgear.prototype.subscribe=function(topic){if(self.client&&self.client.isConnected()){if(self.subscriptions.indexOf(topic)<0){self.client.subscribe("/"+self.appid+topic,{onSuccess:function(res){if(self.subscriptions.indexOf(topic)<0){self.subscriptions.push(topic)}},onFailure:function(res){}})}}else{if(self.subscriptions.indexOf(topic)<0){self.subscriptions.push(topic)}}};_microgear.prototype.unsubscribe=function(topic,callback){if(self.client&&self.client.isConnected()){self.client.unsubscribe("/"+self.appid+topic,{onSuccess:function(res){if(self.subscriptions.indexOf(topic)<0){self.subscriptions.splice(self.subscriptions.indexOf(topic))}},onFailure:function(res){}})}else{if(self.subscriptions.indexOf(topic)>=0){self.subscriptions.splice(self.subscriptions.indexOf(topic))}}};_microgear.prototype.publish=function(_topic,_msg,_retained){var str_msg="";if(typeof _msg=="undefined")return;else if(typeof _msg=="object")str_msg=JSON.stringify(_msg);else str_msg=_msg.toString();var message=new Paho.MQTT.Message(str_msg);if(_retained)message.retained=true;if(self.client&&self.client.isConnected()){message.destinationName="/"+self.appid+_topic;self.client.send(message)}else{if(self.messageBuffer.length<MESSAGEBUFFERSIZE){message.destinationName=_topic;self.messageBuffer.push(message)}}};_microgear.prototype.setname=function(gearname){if(self.gearname)self.unsubscribe("/gearname/"+self.gearname);self.subscribe("/gearname/"+gearname,function(){self.gearname=gearname;if(typeof callback=="function")callback()})};_microgear.prototype.setalias=function(gearalias,callback){self.publish("/@setalias/"+gearalias,"",{},function(){self.gearalias=gearalias;if(typeof callback=="function")callback()})};_microgear.prototype.unsetname=function(callback){if(self.gearname!=null){self.unsubscribe("/gearname/"+self.gearname,function(){self.gearname=null;if(typeof callback=="function")callback()})}};_microgear.prototype.writefeed=function(feedid,datajson,apikey){var cmd="/@writefeed/"+feedid;if(apikey)cmd+="/"+apikey;if(typeof datajson=="object")datajson=JSON.stringify(datajson);else datajson=datajson.toString();self.publish(cmd,datajson)};_microgear.prototype.chat=function(gearname,message,callback){self.publish("/gearname/"+gearname,message,callback)};_microgear.prototype.gettoken=function(){var tok={token:self.accesstoken.token,secret:self.accesstoken.secret};console.log(tok);return tok};_microgear.prototype.resettoken=function(callback){var atok=jsonparse(storage.get("microgear."+self.gearkey+".accesstoken"));if(atok&&atok.token&&atok.revokecode){var xmlHttp=new XMLHttpRequest;xmlHttp.onreadystatechange=function(){if(xmlHttp.readyState==4){switch(xmlHttp.status){case 200:if(xmlHttp.responseText!="FAILED"){if(validateLocalStorage()){self.requesttoken={};self.accesstoken={};storage.set("microgear."+self.gearkey+".key","");storage.set("microgear."+self.gearkey+".accesstoken",JSON.stringify({}));storage.set("microgear."+self.gearkey+".requesttoken",JSON.stringify({}))}}if(typeof callback=="function")callback();break;default:self.emit("error","Reset token error : "+xmlHttp.responseText);if(typeof callback=="function")callback(xmlHttp.responseText);break}}};var revokecode=atok.revokecode.replace(/\//g,"_");var apiurl="http://"+GEARAUTH+":"+GEARAPIPORT+"/api/revoke/"+atok.token+"/"+revokecode;xmlHttp.open("GET",apiurl,true);xmlHttp.send(null)}else{if(typeof callback=="function")callback()}};_microgear.prototype.on("newListener",function(event,listener){switch(event){case"present":if(self.client){if(self.client.isConnected()){self.subscribe("/@present")}}break;case"absent":if(self.client){if(self.client.isConnected()){self.subscribe("/@absent")}}break}});_microgear.prototype.usetls=function(tls){self.securemode=tls};_microgear.prototype.connected=function(){if(self.client){return self.client.isConnected()}else return false};_microgear.prototype.setconfig=function(key,value){switch(key){case"GEARAUTH":GEARAUTH=value.toString();break}};_microgear.prototype.getconfig=function(key){switch(key){case"GEARAUTH":return GEARAUTH;break}};_microgear.prototype.setName=_microgear.prototype.setname;_microgear.prototype.unsetName=_microgear.prototype.unsetname;_microgear.prototype.setAlias=_microgear.prototype.setalias;_microgear.prototype.writeFeed=_microgear.prototype.writefeed;_microgear.prototype.getToken=_microgear.prototype.gettoken;_microgear.prototype.resetToken=_microgear.prototype.resettoken;_microgear.prototype.useTLS=_microgear.prototype.usetls;_microgear.prototype.setConfig=_microgear.prototype.setconfig;_microgear.prototype.getConfig=_microgear.prototype.getconfig;if(gkey&&gsecret){var mg=new _microgear(gkey,gsecret,galias);mg.scope=param.scope;self=mg;return mg}else{return null}};